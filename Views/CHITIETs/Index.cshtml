@model IEnumerable<LTW4.Models.CHITIET>

@{
    ViewBag.Title = "Chi tiết";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2>Chi tiết giao dịch</h2>

<div class="row">
    <div class="col-md-6">
        @using (Html.BeginForm("Index", "CHITIETs"))
        {
            <div class="btn-group">
                <div class="form-outline d-flex align-items-center" style="border: gray solid 1px; border-radius: 5px;">
                    <input type="search" id="form1" name="search" class="form-control" placeholder="Tìm kiếm" />
                </div>
                <button type="submit" style="margin-left:1% ; border-radius:5px;min-width:fit-content;" class="btn btn-dark"><i class="fa-solid fa-magnifying-glass"></i> Search</button>
            </div>
        }
    </div>
    <div class="col-md-6 col-12 d-flex justify-content-md-end justify-content-start align-items-center my-2">
        <button style="background-color: #F27979" class="btn" onclick="themchitiet()"><i class="fa-solid fa-plus"></i> Thêm giao dịch</button>
    </div>
</div>
<br />
<div class="table-responsive">

    <table class="table table-hover table-bordered" style="border-radius: 10px; overflow: hidden;">
        <tr style="background-color: #F27979">
            <th>
                Số tài khoản 
            </th>
            <th>
                Tên khách hàng
            </th>
            <th>
                Ngày giao dịch
            </th>
            <th>
                Loại lãi suất
            </th>
            <th>
                Tên ngoại tệ
            </th>
            <th>
                Số tiền giao dịch
            </th>
            <th>
                Tổng tiền sau lãi (VND)
            </th>
            <th>
                Hạn rút
            </th>
            <th></th>
        </tr>

        @foreach (var item in Model)
        {
            <tr>
                <td>
                    @Html.DisplayFor(modelItem => item.sosotk)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.SOTIETKIEM.tenkh)
                </td>
                <td>
                    @string.Format("{0:dd-MM-yyyy}", item.ngaygiaodich)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.LAISUAT.ghichu)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.NGOAITE.tenngoaite)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.sotiengiaodich)
                </td>
                <td>
                    @Html.DisplayFor(modelItem => item.tongtiensaulai)
                </td>
                <td>
                    @string.Format("{0:dd-MM-yyyy}", item.hanrut)
                </td>
                <td>
                    <div class="text-nowrap">
                        <button class="btn btn-outline-warning btn-sm" data-magiaodich="@item.magiaodich" onclick="editchitiet(this)"><i class="fa-regular fa-pen-to-square"></i> Sửa</button>
                        <button class="btn btn-outline-primary btn-sm" onclick="detailschitiet('@item.magiaodich','@item.sosotk','@item.ngaygiaodich','@item.malaisuat','@item.mangoaite','@item.sotiengiaodich','@item.tongtiensaulai','@item.hanrut','@item.SOTIETKIEM.tenkh')"><i class="fa-solid fa-circle-info"></i> Chi tiết</button>
                        <button class="btn btn-outline-danger btn-sm" onclick="detailsxoa('@item.magiaodich','@item.sosotk','@item.ngaygiaodich','@item.malaisuat','@item.mangoaite','@item.sotiengiaodich','@item.tongtiensaulai','@item.hanrut','@item.SOTIETKIEM.tenkh')"><i class="fa-solid fa-trash-can"></i> Xóa</button>
                    </div>
                </td>
            </tr>
        }

    </table>
</div>
@Html.Partial("masterdetails2")
@section scripts{
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
    <script src="~/Scripts/popper.js"></script>
    <link href="~/Content/toastr.css" rel="stylesheet" />
    <script src="~/Scripts/toastr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
    <script>
        function themchitiet() {
            $("#chitietModal").modal('show');
        };


        var reloadmodal2 = false;


        function editdetails(event) {
            event.preventDefault();
            var magiaodich = $("#magiaodich4").val();
            var sosotk = $("#sosotk4").val();
            var tenkh = $("#tenkh4").val();
            var malaisuat = $("#malaisuat4").val();
            var mangoaite = $("#mangoaite4").val();
            var sotiengiaodich = $("#sotiengiaodich4").val();

            $("#sosotk9").val(sosotk);
            $("#magiaodich9").val(magiaodich);
            $("#tenkh9").val(tenkh);
            $("#malaisuat9").val(malaisuat);
            $("#malaisuat9").trigger("chosen:updated");
            $("#mangoaite9").val(mangoaite);
            $("#mangoaite9").trigger("chosen:updated");
            $("#sotiengiaodich9").val(sotiengiaodich);
            $("#chitietModal1").modal('hide');
            $("#chitietModal5").modal('show');
        };


        $("#chitietModal5").on('hide.bs.modal', function (e) {
            $("#chitietModal1").modal('show');
        });


        function saveeditchitiet2(event) {
            event.preventDefault();
            var magiaodich = $('#magiaodich9').val();
            var sosotk = $('#sosotk9').val();
            var tenkh = $('#tenkh9').val();
            var malaisuat = $('#malaisuat9').val();
            var mangoaite = $('#mangoaite9').val();
            var sotiengiaodich = $('#sotiengiaodich9').val();
            $('#sosotk4').val(sosotk);
            $('#magiaodich4').val(magiaodich);
            $('#tenkh4').val(tenkh);
            $('#mangoaite4').val(mangoaite);
            $('#malaisuat4').val(malaisuat);
            $('#sotiengiaodich4').val(sotiengiaodich);
            $.ajax({
                url: '/CHITIETs/capnhatchitiet',
                type: 'POST',
                data: {
                    magiaodich: magiaodich,
                    sosotk: sosotk,
                    tenkh: tenkh,
                    mangoaite: mangoaite,
                    malaisuat: malaisuat,
                    sotiengiaodich: sotiengiaodich
                },
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công',
                            text: 'Thông tin khách hàng đã được chỉnh sửa.',
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            $("#chitietModal5").modal('hide');
                            reloadmodal2 = true;
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: 'Đã xảy ra lỗi, không thể chỉnh sửa thông tin khách hàng này.',
                            confirmButtonColor: '#d33',
                            confirmButtonText: 'OK'
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Đã xảy ra lỗi trong quá trình cập nhật!',
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }


        $('#chitietModal1').on('hidden.bs.modal', function (e) {
            if (reloadmodal2) {
                location.reload();
                reloadmodal2 = false;
            }
        });


        function editchitiet(button) {
            var magiaodich = $(button).data('magiaodich');
            $.ajax({
                url: '/CHITIETs/editchitiet',
                type: 'GET',
                data: { id: magiaodich },
                success: function (response) {
                    $("#sosotk6").val(response.sosotk);
                    $("#magiaodich6").val(response.magiaodich);
                    $("#tenkh6").val(response.tenkh);
                    $("#malaisuat6").val(response.malaisuat);
                    $("#malaisuat6").trigger("chosen:updated");
                    $("#mangoaite6").val(response.mangoaite);
                    $("#mangoaite6").trigger("chosen:updated");
                    $("#sotiengiaodich6").val(response.sotiengiaodich);
                    $("#chitietModal3").modal('show');
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Lỗi khi lấy thông tin giao dịch',
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }


        function saveeditchitiet(event) {
            event.preventDefault();
            var magiaodich = $('#magiaodich6').val();
            var sosotk = $('#sosotk6').val();
            var tenkh = $('#tenkh6').val();
            var malaisuat = $('#malaisuat6').val();
            var mangoaite = $('#mangoaite6').val();
            var sotiengiaodich = $('#sotiengiaodich6').val();
            $.ajax({
                url: '/CHITIETs/capnhatchitiet',
                type: 'POST',
                data: {
                    magiaodich: magiaodich,
                    sosotk: sosotk,
                    tenkh: tenkh,
                    malaisuat: malaisuat,
                    mangoaite: mangoaite,
                    sotiengiaodich: sotiengiaodich
                },
                success: function (response) {
                    if (response.success) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công',
                            text: 'Thông tin giao dịch đã được chỉnh sửa.',
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'OK'
                        }).then(() => {
                            location.reload();
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: 'Đã xảy ra lỗi, không thể chỉnh sửa thông tin giao dịch này.',
                            confirmButtonColor: '#d33',
                            confirmButtonText: 'OK'
                        });
                    }
                },
                error: function (xhr, status, error) {
                    console.error(error);
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Đã xảy ra lỗi trong quá trình chỉnh sửa!',
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'OK'
                    });
                }
            });
        }


        function detailschitiet(magiaodich, sosotk, ngaygiaodich, malaisuat, mangoaite, sotiengiaodich, tongtiensaulai, hanrut, tenkh) {
            $("#tenkh4").val(tenkh).prop('readonly', true);
            $("#sosotk4").val(sosotk).prop('readonly', true);
            $("#magiaodich4").val(magiaodich).prop('readonly', true);
            $("#ngaygiaodich4").val(ngaygiaodich).prop('readonly', true);
            $("#malaisuat4").val(malaisuat).prop('readonly', true);
            $("#mangoaite4").val(mangoaite).prop('readonly', true);
            $("#sotiengiaodich4").val(sotiengiaodich).prop('readonly', true);
            $("#tongtiensaulai4").val(tongtiensaulai).prop('readonly', true);
            $("#hanrut4").val(hanrut).prop('readonly', true);
            $("#chitietModal1").modal('show');
        }


        function detailsxoa(magiaodich, sosotk, ngaygiaodich, malaisuat, mangoaite, sotiengiaodich, tongtiensaulai, hanrut, tenkh) {
            $("#tenkh5").val(tenkh).prop('readonly', true);
            $("#magiaodich5").val(magiaodich).prop('readonly', true);
            $("#sosotk5").val(sosotk).prop('readonly', true);
            $("#ngaygiaodich5").val(ngaygiaodich).prop('readonly', true);
            $("#malaisuat5").val(malaisuat).prop('readonly', true);
            $("#mangoaite5").val(mangoaite).prop('readonly', true);
            $("#sotiengiaodich5").val(sotiengiaodich).prop('readonly', true);
            $("#tongtiensaulai5").val(tongtiensaulai).prop('readonly', true);
            $("#hanrut5").val(hanrut).prop('readonly', true);
            $("#chitietModal2").modal('show');
        }


        function xoachitiet(magiaodich) {
            var magiaodich = $('#magiaodich5').val();
            Swal.fire({
                icon: 'question',
                title: 'Xác nhận xóa',
                text: 'Bạn có chắc muốn xóa giao dịch này không?',
                showCancelButton: true,
                confirmButtonColor: '#3085d6',
                cancelButtonColor: '#d33',
                confirmButtonText: 'Đồng ý',
                cancelButtonText: 'Hủy bỏ'
            }).then((result) => {
                if (result.isConfirmed) {
                    $.ajax({
                        url: '/CHITIETs/xoachitiet',
                        type: 'POST',
                        data: { id: magiaodich },
                        success: function (response) {
                            if (response.success) {
                                Swal.fire({
                                    icon: 'success',
                                    title: 'Thành công',
                                    text: 'Đã xóa thành công giao dịch.',
                                    confirmButtonColor: '#3085d6',
                                    confirmButtonText: 'OK'
                                }).then(() => {
                                    location.reload();
                                });
                            } else {
                                Swal.fire({
                                    icon: 'error',
                                    title: 'Lỗi',
                                    text: 'Có lỗi xảy ra, không thể xóa giao dịch này.',
                                    confirmButtonColor: '#d33',
                                    confirmButtonText: 'OK'
                                });
                            }
                        },
                        error: function () {
                            Swal.fire({
                                icon: 'error',
                                title: 'Lỗi',
                                text: 'Lỗi server.',
                                confirmButtonColor: '#d33',
                                confirmButtonText: 'OK'
                            });
                        }
                    });
                }
            });
        }



        $(document).on('click', '#addToList2', function (e) {
            e.preventDefault();
            var malaisuat = $.trim($("#malaisuat").val()),
                mangoaite = $.trim($("#mangoaite").val()),
                sotiengiaodich = $.trim($("#sotiengiaodich").val()),
                detailsTableBody2 = $("#detailsTable2 tbody");
            if (malaisuat != "" && mangoaite != "" && sotiengiaodich != "") {
                var giaodichItem = '<tr><td>' + malaisuat + '</td><td>' + mangoaite + '</td><td>' + sotiengiaodich + '</td><td><a href="#" class="delete-product" data-itemId="0">Xóa</a></td></tr>';
                detailsTableBody2.append(giaodichItem);
                clearItem();
            }
        });


        function clearItem() {
            $("#malaisuat").val('');
            $("#mangoaite").val('');
            $("#sotiengiaodich").val('');
        };


        $(document).on('click', '.delete-product', function (e) {
            e.preventDefault();
            $(this).closest('tr').fadeOut(500, function () {
                $(this).remove();
            });
        });


        function savetrade1(data) {
            return $.ajax({
                contentType: 'application/json; charset=utf-8',
                dataType: 'json',
                type: 'POST',
                url: "/CHITIETs/savetrade1",
                data: data,
                success: function (result) {
                    if (Object.keys(result).length !== 0) {
                        Swal.fire({
                            icon: 'success',
                            title: 'Thành công',
                            text: 'Giao dịch đã được thêm thành công.',
                            confirmButtonColor: '#3085d6',
                            confirmButtonText: 'OK'
                        }).then((result) => {
                            if (result.isConfirmed) {
                                location.reload();
                            }
                        });
                    } else {
                        Swal.fire({
                            icon: 'error',
                            title: 'Lỗi',
                            text: 'Giao dịch chưa được hoàn thành.',
                            confirmButtonColor: '#d33',
                            confirmButtonText: 'OK'
                        });
                    }
                },
                error: function () {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi',
                        text: 'Đã xảy ra lỗi trong quá trình xử lý.',
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'OK'
                    });
                }
            });
        };
        $(document).ready(function () {
            $("#savetrade1").click(function (e) {
                e.preventDefault();
                var themchitietArr = [];
                $("#detailsTable2 tbody tr").each(function () {
                    var row = $(this);
                    themchitietArr.push({
                        malaisuat: row.find('td:eq(0)').text(),
                        mangoaite: row.find('td:eq(1)').text(),
                        sotiengiaodich: parseFloat(row.find('td:eq(2)').text().replace(/,/g, '')),
                    });
                });
                var sosotk = $("#sosotkdropdown").val();
                var data = JSON.stringify({
                    sosotk: sosotk,
                    themchitiet: themchitietArr
                });
                savetrade1(data).done(function (response) {
                }).fail(function (xhr, status, error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Lỗi khi lưu',
                        text: error,
                        confirmButtonColor: '#d33',
                        confirmButtonText: 'OK'
                    });
                });
            });
        });

    </script>
}